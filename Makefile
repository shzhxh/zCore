# Makefile for top level of zCore

# Possible things to $(MAKE):
#
# rootfs : contains alpine-rootfs, and compiled binary of linux-syscall/test/*.c
# libc-test : build binary of libc-test for x86_64
# image : make a normal x86_64 image from alpine-rootfs
# riscv-image : make a riscv64 image from riscv-rootfs for testing
# clean : delete all files generated by compilation
# doc : cargo doc --open
# baremetal-test-img : make a x86_64 image for testing

PATH := $(PATH):$(PWD)/toolchain/riscv64-linux-musl-cross/bin

ARCH ?= x86_64
OUT_IMG := zCore/$(ARCH).img

.PHONY: rootfs clone-libc-test libc-test image baremetal-test-img riscv-image check doc clean

rootfs:
	cargo rootfs $(ARCH)

clone-libc-test:
	cargo xtask libc-test

libc-test: clone-libc-test rootfs
	@rm -rf rootfs/libc-test && cp -r ignored/libc-test rootfs
	@cd rootfs/libc-test && cp config.mak.def config.mak && echo 'CC := musl-gcc' >> config.mak && make -j

image: rootfs
	@echo Generating $(OUT_IMG)
	cargo image $(ARCH)

	@rcore-fs-fuse $(OUT_IMG) rootfs zip
# recover rootfs/ld-musl-x86_64.so.1 for zcore usr libos
# libc-libos.so (convert syscall to function call) is from https://github.com/rcore-os/musl/tree/rcore
	@cp prebuilt/linux/libc-libos.so rootfs/lib/ld-musl-x86_64.so.1
	@echo Resizing $(OUT_IMG)
	@qemu-img resize $(OUT_IMG) +5M

baremetal-test-img: libc-test image

riscv-image: rootfs clone-libc-test
	@echo Generating $(OUT_IMG)
	cargo image $(ARCH)

	@mv riscv_rootfs/libc-test riscv_rootfs/libc-test-prebuild
	@cp -r ignored/libc-test riscv_rootfs
	@cd riscv_rootfs/libc-test && cp config.mak.def config.mak && make ARCH=riscv64 CROSS_COMPILE=riscv64-linux-musl- -j
	@cd riscv_rootfs && cp libc-test-prebuild/functional/tls_align-static.exe libc-test/src/functional/

	@rcore-fs-fuse $(OUT_IMG) riscv_rootfs zip
	@echo Resizing $(OUT_IMG)
	@qemu-img resize -f raw $(OUT_IMG) +5M

check:
	cargo xtask check

doc:
	cargo doc --open

clean:
	cargo clean
	find zCore -maxdepth 1 -name "*.img" -delete
	rm -rf rootfs
	rm -rf riscv_rootfs
	rm -rf toolchain
	find zCore/target -type f -name "*.zbi" -delete
	find zCore/target -type f -name "*.elf" -delete

rt-test:
	cd rootfs && git clone https://kernel.googlesource.com/pub/scm/linux/kernel/git/clrkwllms/rt-tests --depth 1
	cd rootfs/rt-tests && make
	echo x86 gcc build rt-test,now need manual modificy.
